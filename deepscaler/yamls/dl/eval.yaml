description: eval

target:
  service: singularity
  name: msrresrchvc
  resource_group: gcr-singularity-resrch
  # workspace_name: Workspace_NLC
  workspace_name: NLC_Workspace



# target:
#   service: sing
#   name: msrresrchvc
#   resource_group: gcr-singularity-resrch
#   workspace_name: Workspace_NLC

# target:
#   service: aml
#   name: alta1

environment:
  image: buaahsh/nvcr:24.07-py3-scalerl-0211
  # image: buaahsh/nvcr:pytorch-24.05-py3-verl
  setup:
  - echo "OK"
  # - chmod 777 -R /opt/conda/envs
  # - chown -R aiscuser /opt/conda/envs
  # - conda init bash; source ~/.bashrc; source /opt/conda/etc/profile.d/conda.sh
  # - conda activate open
  # - echo 'conda ok'

code:
  local_dir: $CONFIG_DIR/../..

storage:
  danlongyuan:
    storage_account_name: msranlpintern
    container_name: danlongyuan

search:
  job_template:
    name: eval
    identity: managed
    priority: high
    sku: 1x40G1-A100-IB-NvLink
    mpi: True
    process_count_per_node: 1
    command:
    - chmod -R 777 ./
    - echo $${rank}
    - bash setup.sh
    - pip list
    - bash ray_node_setup.sh
    - echo {script}
    - bash /mnt/danlongyuan/ShortR1/deepscaler/scripts/eval/eval_model.sh
    tags: [Project_Name:deepscaler1.5b_8k, ProjectID:dasdasd, Experiment:deepscaler1.5b_8k]
    submit_args:
      env:
        SINGULARITY_MPI_ENV: "-mca pml ucx --mca btl ^vader,tcp,openib -x NCCL_SOCKET_IFNAME=bond0 -x NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 -x NCCL_DEBUG=INFO"
      container_args:
        shm_size: 256g
  type: grid
  max_trials: 500
  params:
    - name: rank
      spec: discrete
      values: [1]
    - name: script
      spec: discrete
      values: ['run_deepscaler_1.5b_8k.sh']
